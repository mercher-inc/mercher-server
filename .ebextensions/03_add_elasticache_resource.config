{
    "Resources": {
        "RedisCluster":                     {
            "Type":       "AWS::ElastiCache::CacheCluster",
            "Properties": {
                "CacheNodeType":           "cache.t1.micro",
                "CacheSecurityGroupNames": [
                    { "Ref": "RedisClusterSecurityGroup" }
                ],
                "Engine":                  "redis",
                "NumCacheNodes":           "1"
            }
        },
        "RedisClusterSecurityGroup":        {
            "Type":       "AWS::ElastiCache::SecurityGroup",
            "Properties": {
                "Description": "Lock the cluster down"
            }
        },
        "RedisClusterSecurityGroupIngress": {
            "Type":       "AWS::ElastiCache::SecurityGroupIngress",
            "Properties": {
                "CacheSecurityGroupName": { "Ref": "RedisClusterSecurityGroup" }
            }
        },
        "WebServerRole":                    {
            "Type":       "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect":    "Allow",
                            "Principal": { "Service": [ "ec2.amazonaws.com" ] },
                            "Action":    [ "sts:AssumeRole" ]
                        }
                    ]
                },
                "Path":                     "/"
            }
        },
        "WebServerRolePolicy":              {
            "Type":       "AWS::IAM::Policy",
            "Properties": {
                "PolicyName":     "WebServerRole",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect":   "Allow",
                            "Action":   "elasticache:DescribeCacheClusters",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles":          [
                    { "Ref": "WebServerRole" }
                ]
            }
        },
        "WebServerInstanceProfile":         {
            "Type":       "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path":  "/",
                "Roles": [
                    { "Ref": "WebServerRole" }
                ]
            }
        }
    },
    "files":     {
        "/etc/cron.d/get_cluster_config":    {
            "content": "*/5 * * * * root /usr/local/bin/get_cluster_config",
            "mode":    "000644",
            "owner":   "root",
            "group":   "root"
        },
        "/usr/local/bin/get_cluster_config": {
            "content": {
                "Fn::Join": [
                    "",
                    [
                        "#! /bin/bash\n",
                        "aws elasticache describe-cache-clusters ",
                        "         --cache-cluster-id ", {"Ref": "RedisCluster"},
                        "         --show-cache-node-info --region ", { "Ref": "AWS::Region" }, " > /tmp/cacheclusterconfig\n"
                    ]
                ]
            },
            "mode":    "000755",
            "owner":   "root",
            "group":   "root"
        }
    },
    "commands":  {
        "00-uninstall-default-cli": {
            "command": "yum remove -y aws-cli"
        },
        "01-install-aws-cli":       {
            "command": "easy_install awscli"
        },
        "02-get-cluster-config":    {
            "command": "/usr/local/bin/get_cluster_config"
        }
    }
}